# 网络层
- 网络层与网络互联的基本概念
- IPv4协议的基本内容
- IP地址、路由算法与路由协议的基本概念
- 地址解析协议ARP的基本概念与方法
- 路由器与第三层交换的基本概念
- IPv6协议的基本内容
- 移动IP协议的基本概念
- ICMP协议与IGMP协议的基本概念
- MPLS协议与虚拟专网VPN的基本概念

### 1.1 网络层与网络互联
> 网络层通过路有选择算法，为IP分组从源主机到目的主机选择一条合适的传输路径，为传输层提供端-端数据传输服务。
#### 网络互联的设备
> 中间设备又称为中间系统或中继系统
- 物理层中继系统：转发器
- 数据链路层中继系统：网桥或桥接器
- 网络层中继系统：路由器
- 网络层以上的中继系统：网关
#### 网络互联的问题
- 不同的寻址方案
- 不同的最大分组长度
- 不同的网络接入机制
- 不同的超时空之
- 不同的差错恢复方法
- 不同的状态报告方法
- 不同的路有选择技术
- 不同的用户接入控制
- 不同的服务（面向连接和无连接）
- 不同的管理控制方式
#### 虚拟互联网络
> 所谓虚拟互联网络也就是逻辑互联网络，他的意思就是互联起来的各种物理网络的异构性本来是客观存在的但是我们利用IP协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。使用IP协议的虚拟互联网络可简称为IP网

### 1.2 IP协议
#### 1.2.1 IP协议简介
> 网际协议IP是TCP/IP体系中两个最主要的协议之一，与IP协议配套使用的还有四个协议
- 地址解析协议 ARP（Address Resolution Protocol)
- 逆地址解析协议 RARP (Reverse Address Resolution Protocol)
- 网际控制报文协议 ICMP (Internet Control Message Protocol)
- 网际组管理协议 IGMP (Internet Group Management Protocol)
#### 1.2.2 IPv4协议基本内容
##### IP协议的主要特点
- 无连接、不可靠的分组传送服务的协议，提供的是一种尽力而为的服务
- 是点-点的网络层通信协议
- 屏蔽了互联的网络在数据链路层、物理层协议与实现技术上的差异

##### IPv4分组结构
IPv4分组结构.jpg
##### IPv4分组头格式
- 版本：4-->IPv4,6-->IPv6
- 分组头长度：定义了以4字节为一个单位的分组头长度，爆头的固定长度部分为20字节，IP分组的分组头长度必须是4字节的整数倍，如果不是，则由填充字段“添0”补齐
- 区分服务：长度为8位，前六位为区分服务（DS）字段，后两位为拥塞通知（ECN）字段，DS字段只有在IPv4中提供区分服务时才起作用。
- 总长度：一字节为单位的分组头字段与数据字段长度之和，长度为16位，所以IP分组的最大长度为65535字节
- 生存时间：TTL（time-to-live），每经过一个路由转发，TTL减一，当TTL为0时则路由器丢弃该分组并向源主机发送ICMP报文。
- IP协议高层协议类型

协议字段值 | 高层协议类型 | 协议字段值 | 高层协议类型
---|---|---|---
1 | ICMP|17|UDP
2 | IGMP|41|IPv6
6 | TCP|89|OSPF
8 | EGP

- 头检验和：保证分组头部数据完整性，只对分组头进行校验
- 地址：包括源地址和目的地址
- 标识：主机在发送每一个IP分组是，将一个内部计数器加一来产生标识字段的值，用来标识属于同一个IP数据字段的分片。
- 标志：共三位
    * 最高位为0
    * 第二位是不分片（DF）位，DF=0标识可以分片，DF=1则不允许分片
    * 第三位分片值（MF）表示该分片是不是最后一个分片，为1则表示不是最后分片，为0则表示是最后一个分片
- 片偏移字段值表示分片在整个分组中的相对位置，以8字节为单位计数。
- IP分组头选项：可以不使用，最长为40字节，主要用于控制和测试
    * 源路由
    * 记录路由
    * 时间戳
##### 校验和计算方法
- 二进制反码求和，对16位字进行求和运算，如果最高位出现进位，就将进位加到结果的最低位，将最终结果取反得到校验和
### 1.3 IPv4地址
#### 1.3.1 IPv4地址技术发展的阶段
- 标准分类的Ip地址
    * A类地址网络号长为7为，实际允许分配的A类网络供125个
    * B类地址网络号长度14位，允许分配16384个
- 划分子网的三级地址结构，变为“网络号-子网号-主机号”三级结构
- 构成抄网的无类别域间路由CIDR技术
- 网络地址转换NAT技术，支持IP地址重用

#### 1.3.2 标准IP地址的分类
- A类地址
    * 第一块：0.0.0.0~0.255.255.255：特殊用途
    * 第二块：1.0.0.0~1.255.255.255：10.0.0.0~10.255.255.255用于专用地址
    * 第三块：127.0.0.0~127.255.255.255：用于本地回环
    * 主机号全0和全1保留
- B类地址：128.0.0.0~191.255.255.255（主机号全0和全1保留）
- C类地址：192.0.0.0~223.255.255.255（主机号全0和全1保留）
- D类地址：不标识网络，用于多播和其他用途 224.0.0.0~239.255.255.255
- E类地址：用于某些实验室和将来使用 240.0.0.0~247.255.255.255
##### 特殊地址
- 直接广播地址：主机号全1
- 受限广播：255.255.255.255 将一个分组以广播方式发送给本网络所有主机
- “这个网络上的特定主机”地址：网络号全0
- 回送地址：127.0.0.0 网络号为127的分组不能出现在任何网络，用于本地测试
- 专用IP地址(内部网络地址)

类|网络号|总数
---|---|---
A|10.|1
B|172.16~172.31|16
C|192.168.0~192.168.255|255

#### 1.3.3 划分子网的三级地址结构
子网掩码——为了从IP地址中提取子网号
#### 1.3.4 无类别域间路由
- 地址聚合和路由聚合

#### 1.3.5 网络地址转换
- 为了解决IP地址短缺，采用动态分配IP地址方式

### 1.4 路由选择算法与分组交付
路由选择算法主要参数：
- 跳数：转发分组的路由器数量
- 带宽：链路的传输速率
- 延时：从源主机到目标主机花费的时间
- 负载：通过路由器或线路的单位时间通信量
- 可靠性：传输过程中分组丢失率
- 开销：传输过程中的耗费
#### 1.4.1 路由选择算法分类
- 静态路由表：人工建立，适用于小型的网络系统
- 动态路由表：自适应路由选择算法，能较好的适应网络状态的变化
#### 1.4.2 IP路由汇聚
- 最长前缀匹配原则：路由器的路由表项数越少，查询时间就越短，路由汇聚是减少路由表项数的重要手段，路由表项由“网络前缀”和“下一跳地址”组成

### 1.5 路由选择协议
- 内部网关协议
    * 路由信息协议（RIP）
    * 开放最短路径优先协议（OSPF）
- 外部网关协议BGP-4

#### 1.5.1 RIP路由信息协议
> 基于距离向量路由选择算法，主要通过跳数的多少来确定路由的好坏，不考虑带宽并且限定最大跳数为15，超过15时判断为目标网络不可到达
#### 1.5.2 OSPF开放最短路径优先协议
- 1.向本自治系统中所有路由器发送信息
- 2.发送的信息就是与本路由相邻的所有路由的链路状态
- 只有当链路状态发生变化时，才向所有路由器发送此信息

#### OSPF中每个路由器维护三部分内容
- 邻居状态
- 链路状态数据库
- 路由表

#### OSPF的特点
- 不用UDP而是直接用IP数据包传送
- 对于不同的链路可根据IP分组的不同服务类型而设置成不同的代价，对于不同类型的业务可计算出不同的路由
- 如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径，这叫做多路径间的负载平衡
- 所有在OSPF路由器之间的交换的分组都具有鉴别的功能
- 支持可变长度的子网划分和CIDR
- 每一个链路状态都带上一个32位的序号，序号越大就状态越新

#### BGP协议
> BGP协议是运行在自制系统之间的惟一的一种IP路由协议，因为每个自治系统中的边界路由器的数量很少，通过寻找正确的BGP便捷路由器就可以使Internet路由选择的复杂度大大降低。

- BGP路由选择协议的分组：
    * 打开分组
    * 更新分组
    * 保活分组
    * 通知分组

### 1.6 Internet控制报文协议
#### ICMP协议的特点
- 他的报文要封装成IP分组然后传送给数据链路层
- ICMP协议只是要解决IP协议可能出现的不可靠问题，不能独立存在，是IP协议的一个组成部分
- ICMP协议设计的初衷是用于IP协议在执行过程中的出错报告，严格的说是由路由器向源主机报告传输出错的原因。

#### ICMP报文结构
ICMP报文结构示意图.png
- 在IP分组头中，协议字段值为1表示IP分组的数据部分是ICMP报文
- 为了保证ICMP报文传输的正确性，在ICMP报头中有2B的校验字段
- 一下三种情况不产生差错报告报文
    * 对于分片的分组，如果不是第一个分片出错，则不产生ICMP差错报文
    * 多播分组出错，不产生ICMP报文
    * 具有特殊地址（127.0.0.0或0.0.0.0）的分组出错不产生ICMP差错报文

#### ICMP报文类型
##### 差错报告报文
- 目的主机不可到达
- 源主机抑制
- 超时
- 重定向报文
- 参数问题报文
##### ICMP查询报文
- 回应请求和应答
- 时间戳请求和应答
- 地址掩码请求和应答报文
- 路由器询问和通告

### 1.7 IP多播与IGMP协议
#### IP多播实现方法
- 定义了一个租地址，每个组代表一个或多个发送者与一个或多个接受者的一个会话
- 接受者可以用多播地址通知路由器，他希望加入（或退出）哪个多播组
- 发送者使用多播地址发送分组
- 路由器建立一颗从发送者分支出去的多播传递树，这棵树延伸到所有的IP多播成员的网络中，利用这棵树将分组转发到有多播成员的网路中。

### 1.8 MPLS协议与VPN
#### MPLS提供的服务功能
- 提供面向连接与QoS的服务
- 合理利用网络资源
- 支持虚拟专网服务
- 支持多协议
#### VPN
> 虚拟专网（VPN）用于大型网络信息系统与大型企业、跨国公司构成大型网络系统的多个分布在不同地址位置的子网。
##### VPN系统设计基本要求：
- 保证数据传输安全性
- 保证网络服务质量
- 保证网络操作的简便性
- 保证网络系统的可扩展性
##### VPN实现方法
- 租用线路或在ATM网、帧中继网络组建VPN
- MPLS VPN
> 原理：服务提供商为每个VPN分配一个路由表示服，只有属于同一个VPN的用户之间才能通信。

### 1.9 地址解析协议
> 从已知的IP地址找出对应的MAC地址的映射过程称为正向地址解析，相应的协议称为地址解析协议（Address Resolution Protocol）ARP，从已知的MAC地址找出对应的IP地址称为反向地址解析协议（RARP）。
#### ARP基本工作过程

- 由主机A产生“ARP请求分组”
- 将“ARP请求分组”传递到下一层的数据链路层，封装成帧，目的地址为广播地址（ff-ff-ff-ff-ff-ff)
- 接收到“ARP请求分组”的所有主机，如果他的映射表中没有A的IP对应的MAC地址，就存入映射表
- 目的主机在接收到“ARP请求分组”之后就像A发送一个封装了“ARP应答分组”的帧，用单播方式发送给A
- A在受到“ARP应答分组”之后，将目的主机的IP地址、MAC地址存入映射表

### 1.10 移动IP协议

#### 移动IP协议的基本问题
- 移动主机可以通过一个永久的IP地址连接到任何链路上
- 移动主机在切换到新的链路上时，仍然能够与通信对端主机正常通信
#### 移动IP协议的基本特征
- 与现有的Internet协议兼容
- 与底层所采用的的物理传输介质类型无关
- 对传输层及以上的高层协议透明
- 具有良好的可扩展性、可靠性和安全性
#### 移动IPv4协议的基本工作原理
- 代理发现
- 注册
- 分组路由
- 注销

### IPv6协议

#### IPv6协议的主要特征
- 新的协议头格式（并不向下兼容IPv4）
- 巨大的地址空间
- 有效的分级寻址和路由结构
- 有状态和无状态的地址自动配置
- 内置的安全性
- 更好的支持QoS
- 用新协议处理邻主机的交互
- 可扩展性

#### IPv6地址
##### IPv6地址表示方法
> IPv6的128位地址按每16位划分为一个微端，每个微端转换成一个4位的十六进制数，并用冒号隔开（冒号十六进制表示法）
如：21DA:0000:0000:0000:02AA:000F:FE08:9C5A

- 零压缩法：某个微端中的前导零可以用一个零表示，上面的地址可以写为：21DA:0:0:0:2AA:F:FE08:9C5A，中间的零不可省略，每段至少有一个数字。

##### IPv6报头
IPv6报头结构.png
- 版本，与IPv4相同，版本字段值为6，表示IPv6协议
- 流量类型：表示IPv6分组类型或优先级，类似于IPv4的服务类型
- 流标记：对于默认的路由器处理，字段值为0
- 载荷长度：有效载荷长度包括扩展报头和高层PDU，最大长度为65535B
- 下一个报头：如果存在扩展报头，表示下一个扩展报头的类型，如不存在也可以表示传输层报头是TCP或UDP，也可以是ICMP报头
- 跳步限制：可以通过的最大路由器转发数

#### IPv4到IPv6的过渡方法
- 双IP层或双协议栈
- 隧道技术（奖IPv6分组封装称为IPv4分组，整个IPv6分组编程IPv4分组的数据部分）